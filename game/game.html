<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„Ø¹Ø¨Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„ - Ù†Ø³Ø®Ø© Ø£Ø·ÙØ§Ù„</title>
  <style>
    :root{--bg:#fff8f0;--card:#ffffff;--accent:#ff4d4d;--accent2:#ffd23f;--accent3:#66cc66}
    *{box-sizing:border-box}
    body{font-family:Tahoma, Arial, sans-serif;background:linear-gradient(180deg,#fff8f0 0%, #fefefe 100%);display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:18px}
    .game{width:980px;max-width:980px;background:var(--card);box-shadow:0 14px 40px rgba(0,0,0,.08);border-radius:20px;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0;color:#333}
    .controls{display:flex;gap:10px;align-items:center}
    button{background:linear-gradient(180deg,rgba(0,0,0,0.06),transparent);border:none;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .play-btn{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:14px;cursor:pointer}
    .board{display:flex;gap:18px;margin-top:14px}
    .tray, .targets{flex:1;padding:14px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff4f0);min-height:380px}
    .tray{display:flex;gap:12px;flex-wrap:wrap;align-content:flex-start;justify-content:center;padding-top:18px}
    .draggable{width:100px;height:100px;border-radius:18px;display:flex;align-items:center;justify-content:center;cursor:grab;background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.06);flex-direction:column}
    .draggable:active{cursor:grabbing}
    .shape{width:64px;height:64px}
    .targets{display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center}
    .target{width:160px;height:120px;border-radius:16px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#fffbf7);border:2px dashed rgba(0,0,0,.06);position:relative}
    .target.highlight{box-shadow:0 6px 18px rgba(43,108,176,.08);transform:scale(1.02);transition:transform .14s}
    .meta{display:flex;gap:12px;align-items:center}
    .badge{padding:6px 10px;border-radius:12px;background:#fff8ea;border:1px solid rgba(0,0,0,.03);font-weight:700}
    .level-name{font-weight:800;color:#222}
    .score{font-weight:800;color:#222}
    .footer{margin-top:12px;text-align:center;color:#444}
    small{color:#666}
    .hidden{display:none}
    .center-row{display:flex;gap:8px;align-items:center}
    .big-msg{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#fff,#fffaf0);padding:18px;border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.14);text-align:center;z-index:60}
    @media (max-width:980px){.game{width:95%}.board{flex-direction:column-reverse}.targets{flex-direction:row;flex-wrap:wrap}}
  </style>
</head>
<body>
  <div class="game" role="application" aria-label="Ù„Ø¹Ø¨Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„ - Ù„Ù„Ø£Ø·ÙØ§Ù„">
    <header>
      <div>
        <h1>Ù„Ø¹Ø¨Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„ â€” Ù„Ù„Ø£Ø·ÙØ§Ù„ ğŸˆ</h1>
        <div style="font-size:13px;color:#666">Ø·ÙˆÙ‘Ø±ØªÙ‡Ø§ Ù„Ùƒ Ù†Ø³Ø®Ø© Ø£Ù„ÙˆØ§Ù†: Ø£Ø­Ù…Ø± - Ø£ØµÙØ± - Ø£Ø®Ø¶Ø±ØŒ Ù…Ø¹ Ù…Ø³ØªÙˆÙŠØ§Øª ÙˆÙ…ÙˆØ³ÙŠÙ‚Ù‰ Ø®ÙÙŠÙØ©.</div>
      </div>
      <div class="controls">
        <div class="meta">
          <div class="badge level-name">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="levelName">Ø³Ù‡Ù„</span></div>
          <div class="badge score">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
        </div>
        <button id="restart">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button id="musicToggle" class="play-btn">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</button>
      </div>
    </header>
    <div class="board">
      <section class="tray" id="tray" aria-label="Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©"></section>
      <section class="targets" id="targets" aria-label="Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©"></section>
    </div>
    <div class="footer"><small>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø´ÙƒÙ„ ÙˆØ¶Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚. Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ù…Ø³ØªÙˆÙ‰ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø£ØµØ¹Ø¨.</small></div>
  </div>
  <div id="popup" class="big-msg hidden" role="dialog" aria-live="polite"></div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
const LEVELS = [
  {name: 'Ø³Ù‡Ù„', count: 3},
  {name: 'Ù…ØªÙˆØ³Ø·', count: 6},
  {name: 'ØµØ¹Ø¨', count: 9}
];
const COLORS = ['#ff4d4d','#ffd23f','#66cc66']; // Ø£Ø­Ù…Ø± - Ø£ØµÙØ± - Ø£Ø®Ø¶Ø±
const SHAPES = ['triangle','square','circle','star','hexagon','heart','diamond','moon','cross'];

// Ø¹Ù†Ø§ØµØ± DOM
const tray = document.getElementById('tray');
const targets = document.getElementById('targets');
const scoreEl = document.getElementById('score');
const levelNameEl = document.getElementById('levelName');
const popup = document.getElementById('popup');
let score = 0;
let currentLevelIndex = 0;
let musicOn = false;

// WebAudio Ù„Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let musicNodes = [];

function startMusic(){
  if(!AudioContext) return;
  if(!audioCtx) audioCtx = new AudioContext();
  const master = audioCtx.createGain();
  master.gain.value = 0.06;
  master.connect(audioCtx.destination);
  const melody = [523.25,659.25,783.99,1046.5]; // C5,E5,G5,C6
  musicNodes = melody.map((freq, i)=>{
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    g.gain.value = 0;
    osc.connect(g); g.connect(master);
    osc.start();
    return {osc,g};
  });
  let t = 0;
  function playStep(){
    if(!musicOn) return;
    musicNodes.forEach((n, i)=>{
      const when = audioCtx.currentTime + 0.02 + i*0.18 + t*0.01;
      n.gain.cancelScheduledValues(when);
      n.gain.setValueAtTime(0, when);
      n.gain.linearRampToValueAtTime(0.08, when+0.02);
      n.gain.linearRampToValueAtTime(0, when+0.18);
    });
    t++;
    setTimeout(()=>{ if(musicOn) playStep(); }, 600);
  }
  musicOn = true;
  playStep();
}

function stopMusic(){
  musicOn = false;
  if(musicNodes && audioCtx){
    musicNodes.forEach(n=>{ n.gain.cancelScheduledValues(0); });
  }
}

function playSuccess(){
  if(!AudioContext) return;
  if(!audioCtx) audioCtx = new AudioContext();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'triangle'; o.frequency.value = 880;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.28);
  setTimeout(()=>o.stop(), 300);
}

function playError(){
  if(!AudioContext) return;
  if(!audioCtx) audioCtx = new AudioContext();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sawtooth'; o.frequency.value = 220;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
  setTimeout(()=>o.stop(), 250);
}

// SVG shapes generator
function createShapeSVG(type, color){
  if(type==='triangle'){return `<svg class="shape" viewBox="0 0 100 100"><polygon points="50,12 90,88 10,88" fill="${color}"/></svg>`;}
  if(type==='square'){return `<svg class="shape" viewBox="0 0 100 100"><rect x="18" y="18" width="64" height="64" rx="10" fill="${color}"/></svg>`;}
  if(type==='circle'){return `<svg class="shape" viewBox="0 0 100 100"><circle cx="50" cy="50" r="28" fill="${color}"/></svg>`;}
  if(type==='star'){return `<svg class="shape" viewBox="0 0 100 100"><path d="M50 10 L61 40 H95 L67 58 L78 90 L50 70 L22 90 L33 58 L5 40 H39z" fill="${color}"/></svg>`;}
  if(type==='hexagon'){return `<svg class="shape" viewBox="0 0 100 100"><polygon points="50,10 78,30 78,70 50,90 22,70 22,30" fill="${color}"/></svg>`;}
  if(type==='heart'){return `<svg class="shape" viewBox="0 0 100 100"><path d="M50 76 L18 44 A14 14 0 0 1 50 22 A14 14 0 0 1 82 44z" fill